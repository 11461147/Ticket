# 拓元搶票機器人 🎫

自動化拓元售票系統 (tixcraft.com) 的搶票工具，使用 Python + Selenium + ddddocr 實現全自動搶票流程。

## ✨ 功能特色

- 🚀 **全自動搶票流程**：從場次選擇到最終提交一氣呵成
- 🎯 **智能場次選擇**：支援關鍵字匹配或自動選擇第一個可用場次
- ⚡ **純 JS 快速選位**：使用 JavaScript 一次性執行選位，速度提升 10-50 倍
- 🔍 **智能座位篩選**：自動跳過剩餘數量不足的區域與身障專區
- ✅ **自動勾選條款**：自動處理所有必要的 checkbox
- 🤖 **AI 驗證碼識別**：使用 ddddocr 自動識別並填入驗證碼（最多重試 2 次）
- 💾 **設定自動儲存**：輸入內容自動保存，下次啟動自動載入
- 🔄 **智能路由系統**：自動偵測頁面狀態，失敗時自動重整重試
- 🛡️ **防偵測機制**：停用自動化特徵，降低被封鎖機率

## 💻 系統需求

- Python 3.7+
- Chrome 瀏覽器
- Selenium 4.6+（自動下載 ChromeDriver）

## 🚀 快速開始

### 1. 安裝依賴

```bash
pip install -r requirements.txt
```

### 2. 運行程式

```bash
python tixcraft.py
```

> **注意**：程式使用 Selenium 4.6+ 的 selenium-manager 自動下載對應版本的 ChromeDriver，無需手動設定！

## 📖 使用說明

### 基本操作

1. **啟動程式**：執行 `python tixcraft.py`，開啟 GUI 介面
2. **填入搶票網址**：輸入拓元活動頁面網址
3. **設定場次關鍵字**（可選）：輸入場次關鍵字，留空則自動選擇第一個
4. **設定購票張數**：輸入 1-4 的數字
5. **點擊開始搶票**：程式會開啟 Chrome 到拓元首頁
6. **手動登入**：在開啟的瀏覽器中登入你的拓元帳號
7. **進入搶票頁面**：程式會自動偵測並開始搶票流程

### 搶票流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│                        搶票流程                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  使用者點擊「開始搶票」                                          │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  開啟首頁   │ → │  手動登入   │ → │ 進入活動頁  │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                              │                  │
│         ┌────────────────────────────────────┘                  │
│         ▼                                                       │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ 自動選場次 │ → │ JS快速選位 │ → │  確認座位   │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                              │                  │
│         ┌────────────────────────────────────┘                  │
│         ▼                                                       │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ 填寫表單   │ → │ AI辨識驗證 │ → │  自動提交   │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│         │                                    │                  │
│         ▼                                    ▼                  │
│    失敗自動重試 ←──────────────────── 成功完成購票              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 📁 設定檔

程式會自動創建 `tixcraft_config.json` 保存你的設定：

```json
{
  "url": "搶票網址",
  "session": "場次關鍵字",
  "ticket_count": "1"
}
```

## ⚙️ 進階設定

### 時間參數（在 tixcraft.py 開頭）

| 參數 | 預設值 | 說明 |
|------|--------|------|
| `POLL_INTERVAL_MS` | 100ms | 路由輪詢間隔 |
| `AREA_REFRESH_INTERVAL_MS` | 1500ms | 選位失敗時重整間隔 |
| `CAPTCHA_MAX_ATTEMPTS` | 2 | 驗證碼最大嘗試次數 |
| `REFRESH_ON_AREA` | True | 選位失敗時是否自動重整 |

### WebDriverWait 超時設定

| 常數 | 值 | 用途 |
|------|-----|------|
| `WAIT_LIST_ROWS` | 10s | 場次列表載入 |
| `WAIT_AREA_PAGE` | 15s | 選位頁載入 |
| `WAIT_CONFIRM_BTN` | 10s | 確認按鈕可點 |
| `WAIT_FORM_PAGE` | 15s | 表單頁載入 |
| `WAIT_CAPTCHA_IMG` | 15s | 驗證碼圖片出現 |

### 選位邏輯

程式會自動篩選座位區域：
- ✅ 可點擊的區域
- ✅ 剩餘數量 ≥ 購票張數
- ❌ 已售完 / disabled / 不可見
- ❌ 身障專區 / 輪椅區 / 愛心座

---

## 🏗️ 程式架構

### 類別結構總覽

```
┌─────────────────────────────────────────────────────────────┐
│                      TixcraftGUI 類別                       │
├─────────────────────────────────────────────────────────────┤
│  初始化 (__init__)                                           │
│    ├── GUI 元件建立                                         │
│    ├── 設定檔載入                                           │
│    └── 狀態變數初始化                                       │
├─────────────────────────────────────────────────────────────┤
│  設定管理                                                   │
│    ├── load_config()     載入 JSON 設定                     │
│    ├── save_config()     儲存設定                           │
│    ├── apply_config()    套用設定到 GUI                     │
│    └── on_config_change() 自動儲存                          │
├─────────────────────────────────────────────────────────────┤
│  搶票控制                                                   │
│    ├── toggle_ticketing()    開始/暫停切換                  │
│    ├── start_ticketing()     啟動 Selenium                  │
│    └── _wait_for_target_url() URL 監控                      │
├─────────────────────────────────────────────────────────────┤
│  核心流程                                                   │
│    ├── _auto_ticketing()       場次選擇                     │
│    ├── _handle_seat_selection() 座位選擇 (純 JS)            │
│    ├── _confirm_selection()    確認選位                     │
│    ├── _handle_ticket_form()   填寫表單                     │
│    ├── _fill_ticket_form_js()  JS填表單（含身障過濾）       │
│    ├── _handle_captcha()       驗證碼處理                   │
│    └── _submit_form()          提交表單                     │
├─────────────────────────────────────────────────────────────┤
│  路由系統                                                   │
│    ├── _current_stage()      判斷當前頁面階段               │
│    ├── _start_route_loop()   啟動路由心跳                   │
│    ├── _stop_route_loop()    停止路由心跳                   │
│    └── _route_by_page()      依頁面自動導向                 │
└─────────────────────────────────────────────────────────────┘
```

### 核心方法說明

| 方法 | 功能 |
|------|------|
| `_auto_ticketing()` | 自動選擇場次，支援關鍵字匹配 |
| `_handle_seat_selection()` | 純 JS 快速選位，含剩餘數量與身障區篩選 |
| `_confirm_selection()` | 等待並點擊確認按鈕 |
| `_handle_ticket_form()` | 處理購票表單頁面 |
| `_fill_ticket_form_js()` | JS 一次性設定下拉選單與 checkbox |
| `_handle_captcha()` | ddddocr 驗證碼辨識與填入 |
| `_route_by_page()` | 依 URL 自動導向對應處理流程 |

### 頁面階段判斷

| URL 特徵 | 階段 | 處理方法 |
|----------|------|----------|
| `/activity/detail/` | `detail` | 自動導向 game 頁 |
| `/activity/game/` | `game` | `_auto_ticketing()` |
| `/ticket/area/` | `area` | `_handle_seat_selection()` |
| `/ticket/ticket/` | `form/captcha` | `_handle_ticket_form()` |

### 路由系統流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      路由心跳系統                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  _start_route_loop()                                            │
│         │                                                       │
│         ▼  每 100ms                                             │
│  ┌─────────────────┐                                            │
│  │ _route_by_page()│ ←─────────────────────────────┐            │
│  └────────┬────────┘                               │            │
│           │                                        │            │
│           ▼                                        │            │
│  ┌─────────────────┐                               │            │
│  │ _current_stage()│                               │            │
│  └────────┬────────┘                               │            │
│           │                                        │            │
│     ┌─────┴─────┬──────────┬──────────┐           │            │
│     ▼           ▼          ▼          ▼           │            │
│  detail      game       area    form/captcha      │            │
│     │           │          │          │           │            │
│     ▼           ▼          ▼          ▼           │            │
│  導向game  _auto_    _handle_   _handle_          │            │
│            ticketing  seat      ticket_form       │            │
│                │          │          │            │            │
│                └──────────┴──────────┴────────────┘            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### JS 選位效能優勢

| 項目 | 舊版 (Selenium) | 新版 (純 JS) |
|------|-----------------|--------------|
| 通訊次數 | N × 5+ 次 | 1 次 |
| 選位速度 | ~500ms-2s | ~10-50ms |
| 穩定性 | 易因延遲失敗 | 更穩定 |

## 🛡️ 防護機制

| 機制 | 說明 |
|------|------|
| **重入保護** | `_routing` 旗標防止路由重複執行 |
| **白名單限制** | 驗證碼送出後僅在特定頁面動作 |
| **自動重試** | 驗證碼錯誤自動重試（最多 2 次） |
| **自動重整** | 選位無票時自動重整頁面 |
| **狀態監控** | 持續監控 URL 變化，自動導向正確流程 |
| **錯誤處理** | 各階段皆有 try-catch，錯誤後回到路由輪詢 |

## 📦 依賴套件

```
selenium>=4.6.0
ddddocr>=1.4.0
Pillow>=9.0.0
```

## ⚠️ 注意事項

- 請確保在合理範圍內使用，遵守網站服務條款
- 建議在正式搶票前先測試流程
- 網站更新可能需要調整選擇器
- 驗證碼識別率約 80-90%，偶爾需要手動輸入

## 📄 License

MIT License

##  常見問題

### ChromeDriver 相關

**Q: ChromeDriver 啟動失敗**
A: 程式使用 Selenium 4.6+ 自動管理 ChromeDriver，請確保 Selenium 版本正確：
```bash
pip install --upgrade selenium
```

**Q: Chrome 版本不匹配**
A: 更新 Chrome 瀏覽器到最新版本

### 搶票相關

**Q: 找不到場次按鈕**
A: 檢查場次關鍵字是否正確，或留空讓程式自動選擇第一個可用場次

**Q: 選位一直重整**
A: 可能所有區域都已售完或剩餘數量不足，程式會持續重整等待釋票

**Q: 驗證碼識別失敗**
A: ddddocr 對某些驗證碼識別率較低，超過 2 次失敗後會交回路由重試

##  檔案結構

```
Ticket/
 tixcraft.py           # 主程式
 tixcraft_config.json  # 設定檔（自動生成）
 tixcraft_架構說明.md   # 程式架構文件
 requirements.txt      # Python 依賴
 README.md             # 本文件
 tools/
     download_chromedriver.py  # ChromeDriver 下載工具（可選）
```

##  授權條款

本專案僅供學習研究使用，請勿用於商業用途。

---

 如果這個專案對你有幫助，請給個星星支持一下！
